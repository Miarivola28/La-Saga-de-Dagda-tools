<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Saga de Dagda - Hybrid Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=EB+Garamond:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEMES --- */
        :root { --primary: #2c1810; --bg: #f3e5ab; --accent: #8b0000; --border: #8b4513; --text: #1a0f0a; }
        body.theme-t1 { --bg: #f3e5ab; --primary: #1e3a8a; } /* Bleu */
        body.theme-t2 { --bg: #f0fdf4; --primary: #14532d; } /* Vert */
        body.theme-t3 { --bg: #fef2f2; --primary: #7f1d1d; } /* Rouge */
        body.theme-ext { --bg: #faf5ff; --primary: #581c87; } /* Violet */

        body { 
            font-family: 'EB Garamond', serif; 
            background-color: var(--bg);
            color: var(--text);
            transition: background 0.5s ease;
            padding-top: 145px; 
            padding-bottom: 30px;
            font-size: 1.1rem;
        }
        
        h1, h2, h3, button, .title-font, .nav-tab, select, input { font-family: 'MedievalSharp', cursive; }
        
        .card {
            background: rgba(255, 255, 255, 0.8); 
            border: 2px solid var(--primary);
            border-radius: 4px; 
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            margin-bottom: 12px;
        }

        /* --- HEADER --- */
        #main-header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 50;
            background-color: var(--primary); color: #f3e5ab;
            border-bottom: 4px solid rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: background 0.5s;
        }
        .saga-title {
            text-align: center; font-size: 1.4rem; 
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .nav-tab {
            flex: 1; text-align: center; padding: 12px; cursor: pointer;
            border-bottom: 4px solid transparent; opacity: 0.7; font-size: 0.9rem;
        }
        .nav-tab.active { opacity: 1; border-bottom-color: #f3e5ab; background: rgba(255,255,255,0.1); color: #fff; }

        /* --- UI ELEMENTS --- */
        .stat-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.2); }
        .btn-minus { background: #fee2e2; color: #991b1b; }
        .btn-plus { background: #dcfce7; color: #166534; }
        .prog-bar-bg { background: #d1d5db; height: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #4b5563; }
        .prog-bar-fill { height: 100%; transition: width 0.3s; }

        /* --- CARTE (CORRIG√âE: SCROLL + BOUTONS) --- */
        #mapContainer {
            width: 100%; height: 50vh; 
            overflow: auto; /* Scroll natif r√©tabli ! */
            border: 4px double var(--primary); background: #fffdf5; position: relative;
            touch-action: pan-x pan-y; /* Permet le glissement */
        }
        #drawingCanvas { 
            background-image: radial-gradient(#aaa 1px, transparent 1px); background-size: 20px 20px; 
            cursor: crosshair; display: block; transform-origin: 0 0;
        }
        .compass {
            position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; pointer-events: none; opacity: 0.6; z-index: 10;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Brosen_windrose.svg/1024px-Brosen_windrose.svg.png') center/contain no-repeat;
        }
        .map-controls {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 5px; background: var(--primary); border-radius: 0 0 8px 8px;
        }
        .map-btn {
            background: #f3e5ab; color: var(--primary); border: 1px solid #000;
            font-size: 1.2rem; padding: 5px; border-radius: 4px;
        }

        /* --- MODALS & FADE --- */
        .fade-text { transition: opacity 1s; opacity: 0; font-weight: bold; color: #4ade80; margin-left: 5px; font-size: 14px; }
        .fade-in { opacity: 1; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body class="theme-t1">

    <header id="main-header">
        <div class="saga-title">LA SAGA DE DAGDA</div>
        
        <div class="flex justify-between items-center p-2 px-3 gap-2">
            <select id="tomeSelect" onchange="changeTome()" class="bg-black/30 border border-[#f3e5ab] rounded text-xs p-1 text-[#f3e5ab] truncate flex-1 font-serif">
                <option value="1">Tome 1 : La Harpe des quatre saisons</option>
                <option value="2">Tome 2 : La Confr√©rie de Nuada</option>
                <option value="3">Tome 3 : Les Entrailles du temps</option>
                <option value="4">Extension : Le Royaume des Ombres</option>
            </select>
            
            <div class="flex items-center gap-1 bg-black/30 p-1 rounded border border-[#f3e5ab]">
                <span class="text-xs font-bold uppercase ml-1 text-[#f3e5ab]">Chap.</span>
                <input type="number" id="chapterInput" class="w-12 text-center rounded text-black font-bold p-0.5 text-sm" value="1">
                <button onclick="validateChapter()" class="bg-[#f3e5ab] hover:bg-white text-black rounded px-2 py-0.5 text-xs">
                    <i class="fas fa-chevron-right"></i> ALLER
                </button>
                <span id="chapStatus" class="fade-text">OK</span>
            </div>
        </div>

        <div class="flex">
            <div class="nav-tab active" onclick="switchTab('tab-aventure')"><i class="fas fa-scroll"></i> Aventure</div>
            <div class="nav-tab" onclick="switchTab('tab-carte')"><i class="fas fa-map-marked-alt"></i> Carte</div>
            <div class="nav-tab" onclick="switchTab('tab-journal')"><i class="fas fa-book-open"></i> Journal</div>
        </div>
    </header>

    <div class="max-w-3xl mx-auto p-4">

        <div id="setup-screen" class="card p-6 border-l-4 border-l-yellow-600 z-50 relative">
            <h2 class="text-3xl font-bold mb-4 text-center">Nouvelle Partie</h2>
            <div class="space-y-4">
                <input type="text" id="setupName" class="w-full p-2 border border-gray-400 rounded bg-[#fffdf5]" placeholder="Nom du H√©ros">
                <select id="setupMode" class="w-full p-2 border border-gray-400 rounded bg-[#fffdf5]">
                    <option value="Simplifi√©">Mode Simplifi√© (Checkpoints)</option>
                    <option value="Narratif">Mode Narratif</option>
                    <option value="Mortel">Mode Mortel</option>
                </select>
                <select id="setupTalent" class="w-full p-2 border border-gray-400 rounded bg-[#fffdf5]">
                    <option value="Instinct">Instinct</option>
                    <option value="Herbologie">Herbologie</option>
                    <option value="Discr√©tion">Discr√©tion</option>
                    <option value="Persuasion">Persuasion</option>
                    <option value="Observation">Observation</option>
                    <option value="Doigts Agiles">Doigts Agiles</option>
                    <option value="Empratique">Empratique</option>
                </select>
                <button onclick="startGame()" class="w-full bg-[#2c1810] text-[#f3e5ab] p-3 rounded font-bold text-lg border-2 border-[#f3e5ab] shadow-lg">COMMENCER L'AVENTURE</button>
                <div class="text-center text-sm mt-2">- OU -</div>
                <label class="block w-full text-center p-2 bg-gray-200 rounded cursor-pointer border border-gray-400 hover:bg-gray-300">
                    <i class="fas fa-upload"></i> Charger Sauvegarde (.json)
                    <input type="file" class="hidden" onchange="loadFromFile(this)">
                </label>
            </div>
        </div>

        <div id="game-ui" class="hidden">

            <div id="tab-aventure" class="tab-content block space-y-3">
                
                <div id="quickSaveArea" class="hidden mb-2">
                    <button onclick="createCheckpoint()" class="w-full py-2 bg-blue-100 text-blue-900 rounded border border-blue-400 font-bold text-sm shadow hover:bg-blue-200 transition">
                        <i class="fas fa-save"></i> SAUVEGARDE RAPIDE (CHECKPOINT)
                    </button>
                </div>

                <div class="card p-4">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-bold flex items-center gap-1 text-red-800"><i class="fas fa-heart"></i> SANT√â (PV)</span>
                            <div class="flex items-center gap-2">
                                <span id="pvText" class="font-bold text-lg">0/0</span>
                                <div class="flex items-center gap-1 bg-white/50 rounded px-1 border border-gray-300">
                                    <span class="text-[10px] text-gray-500 mr-1">MAX</span>
                                    <div class="stat-btn btn-minus" onclick="modStat('pvMax', -1)">-</div>
                                    <div class="stat-btn btn-plus" onclick="modStat('pvMax', 1)">+</div>
                                </div>
                            </div>
                        </div>
                        <div class="prog-bar-bg"><div id="pvBar" class="prog-bar-fill bg-red-700" style="width: 50%;"></div></div>
                        <div class="flex justify-between mt-2 px-1">
                            <button onclick="modStat('pv', -1)" class="stat-btn btn-minus w-8 h-8">-1</button>
                            <button onclick="modStat('pv', 1)" class="stat-btn btn-plus w-8 h-8">+1</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm font-bold mb-1">
                            <span class="flex items-center gap-1 text-yellow-700"><i class="fas fa-star"></i> CHANCE</span>
                            <span id="chanceText" class="text-lg">0</span>
                        </div>
                        <div class="prog-bar-bg"><div id="chanceBar" class="prog-bar-fill bg-yellow-500" style="width: 0%;"></div></div>
                        <div class="flex justify-between mt-2 px-1">
                            <button onclick="modStat('chance', -1)" class="stat-btn btn-minus w-8 h-8">-1</button>
                            <button onclick="modStat('chance', 1)" class="stat-btn btn-plus w-8 h-8">+1</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 border-t border-gray-300 pt-3 text-center">
                        <div>
                            <div class="text-xs uppercase text-gray-600 font-bold mb-1">üéØ Dext√©rit√©</div>
                            <div class="flex justify-center items-center gap-2">
                                <button onclick="modStat('dex', -1)" class="text-red-500 font-bold px-1 text-lg">-</button>
                                <span id="dexDisplay" class="font-bold text-2xl text-blue-900">7</span>
                                <button onclick="modStat('dex', 1)" class="text-green-600 font-bold px-1 text-lg">+</button>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs uppercase text-gray-600 font-bold mb-1">üë§ Talents</div>
                            <div id="talentDisplay" class="font-bold text-sm leading-tight italic">Instinct</div>
                            <button onclick="addTalent()" class="text-[10px] text-blue-700 underline mt-1 font-sans">+ Ajouter</button>
                        </div>
                        <div>
                            <div class="text-xs uppercase text-gray-600 font-bold mb-1">ü™ô Boulons</div>
                            <input type="number" id="goldDisplay" class="w-16 text-center font-bold text-xl border-b-2 border-yellow-600 bg-transparent" value="0" onchange="updateGold(this)">
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 border-b border-gray-300">üé≤ LANCER DE D√âS</h3>
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col gap-1 w-1/3">
                            <button onclick="rollDiceVisual(1)" class="bg-gray-200 border border-gray-400 text-sm py-1 rounded shadow-sm">1 D√©</button>
                            <button onclick="rollDiceVisual(2)" class="bg-gray-300 border border-gray-400 text-sm py-1 rounded shadow-sm">2 D√©s</button>
                        </div>
                        <div id="diceVisual" class="flex-1 flex justify-center gap-2 h-10 items-center">
                            <span class="text-xs text-gray-400 italic">...</span>
                        </div>
                        <div class="w-1/3 text-center">
                            <div class="text-[10px] text-gray-500 font-sans">Utiliser Chance</div>
                            <div class="flex justify-center gap-1 mt-1">
                                <button onclick="useLuck(-1)" id="lkDn" class="w-8 h-8 bg-yellow-100 border border-yellow-500 rounded disabled:opacity-50 text-yellow-800 font-bold">-</button>
                                <button onclick="useLuck(1)" id="lkUp" class="w-8 h-8 bg-yellow-100 border border-yellow-500 rounded disabled:opacity-50 text-yellow-800 font-bold">+</button>
                            </div>
                        </div>
                    </div>
                    <div id="diceTotal" class="text-center font-bold text-blue-900 mt-2 h-6 text-lg"></div>
                </div>

                <div class="card p-4 border-l-4 border-l-red-800 bg-red-50/50">
                    <h3 class="title-font text-lg font-bold text-red-900 mb-3 flex justify-between items-center">
                        <span>‚öîÔ∏è COMBAT</span>
                        <button onclick="resetCombat()" class="text-xs font-normal text-gray-500 underline font-sans">Nouveau</button>
                    </h3>
                    <div class="flex gap-2 text-sm mb-2">
                        <input id="enemyName" placeholder="Nom Ennemi" class="flex-1 p-1 border border-red-300 rounded bg-white">
                        <input id="enemyPV" type="number" placeholder="PV" class="w-14 p-1 border border-red-300 rounded font-bold text-red-600 text-center bg-white">
                        <input id="enemyDex" type="number" placeholder="Dex" class="w-12 p-1 border border-blue-300 rounded text-blue-600 text-center bg-white">
                    </div>
                    <div class="mb-3">
                         <select id="combatWeapon" class="w-full text-sm border p-1 rounded bg-white"></select>
                    </div>
                    <button onclick="combatRound()" class="w-full bg-red-800 text-[#f3e5ab] py-3 rounded font-bold shadow-md border border-black hover:bg-red-900 text-lg">‚öîÔ∏è COMBATTRE</button>
                    <div id="combatLog" class="h-32 overflow-y-auto bg-white p-2 text-sm border border-gray-300 rounded mt-2 font-serif leading-tight"></div>
                </div>

                <div class="card p-3">
                    <h3 class="title-font font-bold mb-2 flex items-center gap-2"><i class="fas fa-shopping-bag"></i> BESACE</h3>
                    
                    <div class="bg-blue-50 p-2 rounded border border-blue-200 mb-2">
                        <label class="text-[10px] text-gray-500 uppercase font-bold font-sans">Objets d√©tect√©s (Chapitre actuel)</label>
                        <div class="flex gap-1 mt-1">
                            <select id="contextItemSelect" class="flex-1 text-sm border p-1 rounded font-serif"></select>
                            <button onclick="addContextItem()" class="bg-blue-800 text-white px-3 rounded text-sm">+</button>
                        </div>
                    </div>

                    <details class="mb-2">
                        <summary class="text-xs text-gray-600 cursor-pointer p-1 bg-gray-200 rounded font-bold font-sans text-center">+ CR√âER OBJET</summary>
                        <div class="p-2 border mt-1 rounded bg-white space-y-2">
                            <div>
                                <label class="text-[10px] font-bold">Nom</label>
                                <input id="cName" placeholder="Ex: √âp√©e maudite" class="w-full text-xs p-1 border">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] font-bold">Cat√©gorie</label>
                                    <select id="cCat" class="w-full text-xs p-1 border">
                                        <option value="weapon">Arme</option>
                                        <option value="equip">√âquipement</option>
                                        <option value="conso">Consommable</option>
                                        <option value="other">Autre</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold">Stat Affect√©e</label>
                                    <select id="cStat" class="w-full text-xs p-1 border">
                                        <option value="dmg">D√©g√¢ts (Arme)</option>
                                        <option value="pv">Points de Vie</option>
                                        <option value="dex">Dext√©rit√©</option>
                                        <option value="chance">Chance</option>
                                        <option value="none">Aucune</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-[10px] font-bold">Valeur (+/-)</label>
                                    <input id="cVal" type="number" placeholder="0" class="w-full text-xs p-1 border">
                                </div>
                                <div class="flex-1">
                                    <label class="text-[10px] font-bold">Usages</label>
                                    <select id="cUsesType" class="w-full text-xs p-1 border" onchange="toggleUseInput(this.value)">
                                        <option value="-1">Illimit√© / Port√©</option>
                                        <option value="1">Usage Unique</option>
                                        <option value="X">D√©finir nombre...</option>
                                    </select>
                                </div>
                                <div class="w-12 hidden" id="cUsesNbDiv">
                                    <label class="text-[10px] font-bold">Nb</label>
                                    <input id="cUsesNb" type="number" value="3" class="w-full text-xs p-1 border">
                                </div>
                            </div>
                            <button onclick="addCustomItem()" class="w-full bg-gray-300 text-xs py-2 font-bold mt-1 border border-gray-400 rounded">AJOUTER √Ä LA BESACE</button>
                        </div>
                    </details>

                    <ul id="inventoryList" class="space-y-2 pb-2"></ul>
                </div>
            </div>

            <div id="tab-carte" class="tab-content hidden">
                <div class="bg-white p-2 border-b-2 border-[#8b4513] flex justify-between items-center sticky top-[140px] z-20 shadow-sm">
                    <div class="flex gap-1">
                        <select id="mapSelector" onchange="changeMap(this.value)" class="text-xs border rounded w-32 font-serif bg-[#fffdf5]"></select>
                        <button onclick="addMap()" class="text-green-800 bg-green-100 px-2 border border-green-300 rounded text-xs font-bold">+</button>
                    </div>
                    <div class="flex gap-1 items-center">
                        <div class="flex border-r border-gray-300 pr-2 mr-1 gap-1">
                            <button onclick="setPen('black')" class="w-6 h-6 bg-black rounded-full border-2 border-white shadow-sm" title="Noir"></button>
                            <button onclick="setPen('#8b0000')" class="w-6 h-6 bg-red-800 rounded-full border-2 border-white shadow-sm" title="Rouge"></button>
                            <button onclick="setPen('#1e3a8a')" class="w-6 h-6 bg-blue-800 rounded-full border-2 border-white shadow-sm" title="Bleu"></button>
                        </div>
                        <button onclick="setTool('pen')" id="btn-pen" class="px-2 py-1 bg-gray-200 rounded text-sm border border-gray-300"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="setTool('eraser')" id="btn-eraser" class="px-2 py-1 bg-gray-200 rounded text-sm border border-gray-300"><i class="fas fa-eraser"></i></button>
                        <button onclick="setTool('text')" id="btn-text" class="px-2 py-1 bg-gray-200 rounded text-sm border border-gray-300"><i class="fas fa-font"></i></button>
                    </div>
                </div>
                
                <div id="mapContainer">
                    <div class="compass"></div>
                    <canvas id="drawingCanvas" width="2000" height="2000"></canvas>
                </div>

                <div class="map-controls">
                    <button class="map-btn" onclick="panMap(0, 50)" style="grid-column: 2">‚¨ÜÔ∏è</button>
                    <button class="map-btn" onclick="panMap(50, 0)" style="grid-column: 1; grid-row: 2">‚¨ÖÔ∏è</button>
                    <button class="map-btn font-bold text-sm" onclick="changeZoom(-0.1)" style="grid-column: 2; grid-row: 2">üîç-</button>
                    <button class="map-btn" onclick="panMap(-50, 0)" style="grid-column: 3; grid-row: 2">‚û°Ô∏è</button>
                    <button class="map-btn" onclick="panMap(0, -50)" style="grid-column: 2; grid-row: 3">‚¨áÔ∏è</button>
                    
                    <button class="map-btn font-bold text-sm" onclick="changeZoom(0.1)" style="grid-column: 4; grid-row: 1/span 3; display: flex; align-items: center; justify-content: center;">üîç+</button>
                    <div class="text-[10px] text-white flex items-center justify-center font-sans" style="grid-column: 5; grid-row: 1/span 3; text-align:center;">Zoom<br><span id="zoomDisplay">100%</span></div>
                </div>
            </div>

            <div id="tab-journal" class="tab-content hidden space-y-3">
                <div class="card p-3">
                    <h3 class="font-bold text-sm mb-2"><i class="fas fa-feather-alt"></i> NOTES PERSONNELLES</h3>
                    <textarea id="persistentNotes" class="w-full text-sm border p-2 h-40 rounded mb-2 bg-[#fffdf5] font-serif" placeholder="Notez ici vos indices, codes et r√©flexions..." onchange="saveNotes()"></textarea>
                    <div class="flex gap-2">
                        <input id="quickNote" class="flex-1 text-xs border p-1 rounded font-serif" placeholder="Note rapide pour l'historique...">
                        <button onclick="addLogNote()" class="bg-gray-200 text-xs px-2 border rounded font-bold">AJOUTER AU LOG</button>
                    </div>
                </div>

                <div class="card p-3">
                    <h3 class="font-bold text-sm mb-2"><i class="fas fa-history"></i> CHRONIQUE</h3>
                    <div id="historyLog" class="h-64 overflow-y-auto text-sm font-serif bg-[#fffdf5] p-2 border border-gray-300 mt-2 rounded leading-snug text-gray-800"></div>
                </div>
                
                <div class="card p-3">
                    <h3 class="font-bold text-sm mb-2"><i class="fas fa-save"></i> CHECKPOINTS (Max 3)</h3>
                    <div id="cpList" class="space-y-1"></div>
                </div>

                <button onclick="downloadSave()" class="w-full py-3 bg-[#2c1810] text-[#f3e5ab] font-bold rounded mb-4 border border-[#f3e5ab] shadow"><i class="fas fa-download"></i> T√âL√âCHARGER SAUVEGARDE (.JSON)</button>
            </div>

        </div>

    </div>

    <div id="modalDeath" class="modal">
        <div class="bg-[#fffdf5] p-6 rounded shadow-2xl border-4 border-red-900 text-center max-w-sm w-full relative">
            <h2 class="text-4xl font-bold text-red-900 mb-4 title-font" style="text-shadow: 1px 1px 0 #000;">COMBAT PERDU</h2>
            <div id="deathContent" class="space-y-4 mt-4 text-sm font-serif">
                </div>
        </div>
    </div>

    <script>
        // --- DONNEES ---
        const ITEMS_DB = [
            // TOME 1
            {t:1, src:[7], name:"Potion de soin", type:"heal", val:5, uses:1, desc:"Redonne 5 PV."},
            {t:1, src:[16], name:"Collier de charisme", type:"equip_chance", val:2, uses:-1, desc:"+2 Chance (Port√©)."},
            {t:1, src:[20], name:"Fiole de Laurier", type:"none", val:0, uses:1, desc:"+5 Dex (24h)."},
            {t:1, src:[24,228,240], name:"Torche neuve", type:"none", val:0, uses:-1, desc:"√âclaire les lieux sombres."},
            {t:1, src:[76,82,237,295], name:"Cristal", type:"dmg", val:50, uses:-1, desc:"Arme sp√©ciale Dragon/Sage."},
            {t:1, src:[82,237,295], name:"Arc et carquois", type:"dmg", val:0, uses:-1, desc:"Arme √† distance."},
            {t:1, src:[177], name:"√âp√©e courte (+1)", type:"dmg", val:1, uses:-1, desc:"Salle d'armes."},
            {t:1, src:[169], name:"√âp√©e courte (+2)", type:"dmg", val:2, uses:-1, desc:"Camp Gobelin."},
            {t:1, src:[133,269], name:"Pendentif rainure", type:"none", val:0, uses:-1, desc:"Donn√© par le Sage."},
            {t:1, src:[333], name:"Boule rouge", type:"none", val:0, uses:-1, desc:"M√©canisme cartographie."},
            {t:1, src:[343], name:"Boule verte", type:"none", val:0, uses:-1, desc:"M√©canisme salle vide."},
            {t:1, src:[238], name:"Bourse en cuir", type:"gold", val:25, uses:1, desc:"Contient 25 boulons."},
            {t:1, src:[209], name:"Bague 2√®me chance", type:"none", val:0, uses:-1, desc:"Relance d√©s 1x/combat."},
            {t:1, src:[340], name:"Cl√© rouill√©e", type:"none", val:0, uses:-1, desc:"Ouvre grille labyrinthe."},
            {t:1, src:[287], name:"Bracelet de force", type:"equip_dex", val:2, uses:-1, desc:"+2 Dex (Port√©)."},
            {t:1, src:[334], name:"Bague de vitalit√©", type:"equip_pv", val:2, uses:-1, desc:"+2 PV Max/Actuels (Port√©)."},
            // TOME 2 & 3 (Idem versions pr√©c√©dentes)
            {t:2, src:[3,6,124], name:"Champignon poils longs", type:"none", val:0, uses:1, desc:"Objet de qu√™te."},
            {t:2, src:[24], name:"Lettre pli√©e", type:"none", val:0, uses:1, desc:"Message cod√© de Tess."},
            {t:2, src:[102], name:"Pomme verte", type:"heal", val:2, uses:1, desc:"+2 PV."},
            {t:2, src:[47,212], name:"Potion de soin p√¢le", type:"heal", val:3, uses:1, desc:"+3 PV."},
            {t:2, src:[120,135], name:"Souris morte", type:"none", val:0, uses:1, desc:"Richesse de ge√¥le."},
            {t:2, src:[130,248], name:"Pomme rouge", type:"heal", val:2, uses:1, desc:"+2 PV."},
            {t:2, src:[335], name:"M√©lange potions", type:"none", val:0, uses:1, desc:"Ingr√©dient craft."},
            {t:2, src:[181], name:"Bague 2√®me chance", type:"none", val:0, uses:-1, desc:"Relance d√©s."},
            {t:2, src:[272], name:"Re√ßu cheval", type:"none", val:0, uses:1, desc:"Preuve de d√©p√¥t."},
            {t:2, src:[215], name:"Ceinture Paco Tille", type:"gold", val:5, uses:-1, desc:"Vaut 5 boulons."},
            {t:2, src:[50,130,142,183,300], name:"Champignon orange", type:"heal", val:1, uses:1, desc:"+1 PV."},
            {t:3, src:[8], name:"Cl√© du coffre", type:"none", val:0, uses:-1, desc:"Nain Vil Requin."},
            {t:3, src:[219,232], name:"Gros Livre", type:"none", val:0, uses:-1, desc:"D√©clenche dalles."},
            {t:3, src:[236,328], name:"Tige de m√©tal", type:"none", val:0, uses:-1, desc:"Levier."},
            {t:3, src:[272], name:"Poudre d'√âveil", type:"none", val:0, uses:-1, desc:"Poudre bleue."},
            {t:3, src:[304], name:"Potion d'√âveil", type:"none", val:0, uses:1, desc:"Sortir de la boucle."},
            {t:3, src:[53], name:"Bague d'ancrage", type:"equip_chance", val:1, uses:-1, desc:"+1 Chance. Annule 1 blessure/Tome."},
            {t:3, src:[53], name:"Fragment carapace", type:"none", val:0, uses:-1, desc:"Reine Scarab√©e."},
            {t:3, src:[70], name:"Cl√© en bronze", type:"none", val:0, uses:-1, desc:"Donn√©e par le Gardien."},
            {t:3, src:[89], name:"Cl√© Soleil", type:"none", val:0, uses:-1, desc:"T√™te de soleil."},
            {t:3, src:[91], name:"Potion confusion", type:"dmg", val:5, uses:1, desc:"-5 PV Adversaire."},
            {t:3, src:[104], name:"M√©daillon grav√©", type:"none", val:0, uses:-1, desc:"Pour les perdus."},
            {t:3, src:[349], name:"≈íil de Niv√©lis", type:"none", val:0, uses:-1, desc:"Bille bleue."},
            {t:3, src:[192], name:"Anneau des √©chos", type:"none", val:0, uses:-1, desc:"Rejouer une sc√®ne."},
            {t:3, src:[313], name:"Cl√© dor√©e", type:"none", val:0, uses:-1, desc:"Sur le Gardien."},
            {t:3, src:[234], name:"Cl√© cuivre", type:"none", val:0, uses:-1, desc:"Sous le masque."},
            {t:3, src:[296], name:"Cl√© en bois", type:"none", val:0, uses:-1, desc:"Porte atelier."},
            {t:3, src:[308], name:"Cl√© argent√©e", type:"none", val:0, uses:-1, desc:"Vol√©e au Gardien."}
        ];

        let state = {
            hero: { name: "", pv: 0, pvMax: 0, dex: 7, chance: 0, talent: "Instinct", gold: 0 },
            inventory: [],
            tome: 1,
            chapter: 1,
            mode: "Simplifi√©",
            checkpoints: [],
            history: [],
            notes: "",
            maps: {"Plan Principal": ""},
            currentMap: "Plan Principal"
        };

        // --- INIT ---
        function startGame() {
            const h = state.hero;
            h.name = document.getElementById('setupName').value || "Aventurier";
            state.mode = document.getElementById('setupMode').value;
            h.talent = document.getElementById('setupTalent').value;
            
            const d1 = Math.floor(Math.random()*6)+1;
            const d2 = Math.floor(Math.random()*6)+1;
            h.pvMax = (d1+d2)*4; h.pv = h.pvMax;
            h.chance = Math.floor(Math.random()*6)+1;
            h.dex = 7; h.gold = 0;

            addItem("Besace", "none", 0, -1, "Contenant principal");
            addItem("Bourse", "none", 0, -1, "Argent");

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            log(`AVENTURE COMMENC√âE (${state.mode}). PV:${h.pv} Dex:7 Chance:${h.chance}`);
            createCheckpoint();
            changeTome(1); initMap(); updateUI();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            if(id=='tab-aventure') document.querySelectorAll('.nav-tab')[0].classList.add('active');
            if(id=='tab-carte') document.querySelectorAll('.nav-tab')[1].classList.add('active');
            if(id=='tab-journal') document.querySelectorAll('.nav-tab')[2].classList.add('active');
        }

        // --- NAVIGATION ---
        function changeTome(val) {
            const v = val || parseInt(document.getElementById('tomeSelect').value);
            state.tome = v;
            document.getElementById('tomeSelect').value = v;
            const b = document.body; b.className="";
            if(v===1) b.classList.add('theme-t1'); if(v===2) b.classList.add('theme-t2');
            if(v===3) b.classList.add('theme-t3'); if(v===4) b.classList.add('theme-ext');
            log(`Passage au Tome ${v}`); updateContextList();
        }

        function validateChapter() {
            const c = document.getElementById('chapterInput').value;
            goToChapter(c);
            const status = document.getElementById('chapStatus');
            status.classList.add('fade-in');
            setTimeout(() => status.classList.remove('fade-in'), 2000);
        }

        function goToChapter(c) { 
            state.chapter = parseInt(c); 
            log(`D√©placement: Chapitre ${c}`); updateContextList(); 
        }

        // --- STATS ---
        function modStat(stat, val) {
            const h = state.hero;
            if(stat === 'pv') { 
                h.pv += val; if(h.pv>h.pvMax) h.pv=h.pvMax; if(h.pv<0) h.pv=0; 
                log(`Sant√©: ${val>0?'+':''}${val} (Actuel: ${h.pv})`); checkDeath();
            }
            else if(stat === 'pvMax') { h.pvMax += val; log(`PV MAX modifi√©s: ${val>0?'+':''}${val}`); }
            else if(stat === 'dex') { h.dex += val; log(`Dext√©rit√© modifi√©e: ${val>0?'+':''}${val}`); }
            else if(stat === 'chance') { h.chance += val; log(`Chance modifi√©e: ${val>0?'+':''}${val}`); }
            updateUI();
        }
        function addTalent() { 
            const t=prompt("Talent:"); 
            if(t) {state.hero.talent+=`, ${t}`; log(`Nouveau Talent appris: ${t}`); updateUI();} 
        }
        function updateGold(input) {
            const old = parseInt(state.hero.gold); const neo = parseInt(input.value);
            const diff = neo - old;
            if(diff !== 0) { state.hero.gold = neo; log(`Boulons: ${diff>0?'+':''}${diff} (Total: ${neo})`); }
        }

        // --- INVENTAIRE ---
        function toggleUseInput(val) { document.getElementById('cUsesNbDiv').classList.toggle('hidden', val !== 'X'); }
        function addCustomItem() {
            const name = document.getElementById('cName').value;
            const cat = document.getElementById('cCat').value;
            const stat = document.getElementById('cStat').value;
            const val = parseInt(document.getElementById('cVal').value) || 0;
            const useType = document.getElementById('cUsesType').value;
            
            if(!name) return;
            let internal = "none";
            if(cat === 'weapon') internal = 'dmg';
            else if(cat === 'conso' && stat === 'pv') internal = 'heal';
            else if(cat === 'equip') {
                if(stat === 'dex') internal = 'equip_dex'; if(stat === 'chance') internal = 'equip_chance'; if(stat === 'pv') internal = 'equip_pv';
            }
            let uses = -1;
            if(useType === '1') uses = 1;
            if(useType === 'X') uses = parseInt(document.getElementById('cUsesNb').value) || 1;
            
            let desc = `${cat.toUpperCase()}. `;
            if(stat !== 'none') desc += `${stat.toUpperCase()} ${val>0?'+':''}${val}. `;
            addItem(name, internal, val, uses, desc);
        }

        function updateContextList() {
            const s = document.getElementById('contextItemSelect'); s.innerHTML = "";
            const matches = ITEMS_DB.filter(i => i.t === state.tome && i.src.includes(state.chapter));
            if(matches.length === 0) { const o=document.createElement('option'); o.text="-- Aucun d√©tect√© --"; s.add(o); }
            matches.forEach(i => {
                const o = document.createElement('option'); o.value = JSON.stringify(i); o.text = i.name; s.add(o);
            });
        }
        function addContextItem() {
            const val = document.getElementById('contextItemSelect').value;
            if(!val || !val.includes('{')) return;
            const t = JSON.parse(val);
            addItem(t.name, t.type, t.val, t.uses, t.desc);
        }
        function addItem(name, type, val, uses, desc) {
            if(type === 'gold') {
                state.hero.gold = parseInt(state.hero.gold) + val;
                log(`Trouv√© ${val} boulons`); updateUI(); return;
            }
            state.inventory.push({ id: Date.now(), name, type, val, uses, desc: desc || "", equipped: false });
            log(`Ajout√©: ${name}`); updateUI();
        }
        function useItem(id) {
            const idx = state.inventory.findIndex(i=>i.id===id);
            const item = state.inventory[idx];
            if(item.type === 'heal') { modStat('pv', item.val); log(`Consomm√©: ${item.name} (+${item.val} PV)`); } 
            else { log(`Utilis√©: ${item.name}`); }
            if(item.uses > 0) {
                item.uses--; if(item.uses === 0) { state.inventory.splice(idx,1); log(`${item.name} √©puis√©.`); }
            }
            updateUI();
        }
        function toggleEquip(id) {
            const item = state.inventory.find(i=>i.id===id);
            if(!item) return;
            item.equipped = !item.equipped;
            const m = item.equipped ? 1 : -1;
            log(`${item.equipped?'√âquip√©':'Retir√©'}: ${item.name}`);
            if(item.type === 'equip_dex') state.hero.dex += (item.val*m);
            if(item.type === 'equip_pv') { state.hero.pvMax += (item.val*m); state.hero.pv += (item.val*m); }
            if(item.type === 'equip_chance') state.hero.chance += (item.val*m);
            updateUI();
        }
        function trashItem(id) {
            if(confirm("Jeter ?")) {
                const item = state.inventory.find(i=>i.id===id);
                if(item.equipped) toggleEquip(id);
                state.inventory = state.inventory.filter(i=>i.id !== id);
                log(`Jet√©: ${item.name}`); updateUI();
            }
        }
        function renderInventory() {
            const l = document.getElementById('inventoryList');
            const ws = document.getElementById('combatWeapon');
            l.innerHTML = ""; ws.innerHTML = '<option value="0">Mains nues</option>';
            state.inventory.forEach(i => {
                if(i.type === 'dmg') { const opt = document.createElement('option'); opt.value = i.val; opt.text = `${i.name} (+${i.val})`; ws.add(opt); }
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-300";
                let btn = "";
                if(i.type === 'heal' || (i.type === 'none' && i.uses > 0)) {
                    btn = `<button onclick="useItem(${i.id})" class="text-[10px] bg-green-100 text-green-800 px-2 py-1 rounded mr-2 border border-green-200 uppercase font-bold">Utiliser</button>`;
                } else if (i.type.startsWith('equip')) {
                    const txt = i.equipped ? "RETIRER" : "√âQUIPER";
                    const cls = i.equipped ? "bg-blue-800 text-white" : "bg-gray-200 text-black";
                    btn = `<button onclick="toggleEquip(${i.id})" class="text-[10px] ${cls} px-2 py-1 rounded mr-2 uppercase font-bold border border-gray-400">${txt}</button>`;
                }
                const usesTxt = i.uses > 0 ? `(x${i.uses})` : (i.uses===-1?"(‚àû)":"");
                li.innerHTML = `
                    <div class="flex-1 ${i.equipped?'font-bold text-blue-900':''}">
                        <div class="font-serif text-lg">${i.name} <span class="text-xs text-gray-500 font-sans">${usesTxt}</span></div>
                        <div class="text-[11px] text-gray-500 italic">${i.desc}</div>
                    </div>
                    <div class="flex items-center">${btn}<i onclick="trashItem(${i.id})" class="fas fa-trash text-red-300 hover:text-red-600 cursor-pointer ml-1"></i></div>
                `;
                l.appendChild(li);
            });
        }

        // --- CHECKPOINTS & SAVE ---
        function createCheckpoint() {
            const currentCPs = state.checkpoints || []; 
            if(currentCPs.length >= 3) currentCPs.shift(); 
            const snapshot = JSON.stringify(state);
            currentCPs.push({ date: new Date().toLocaleTimeString(), chap: state.chapter, data: snapshot });
            state.checkpoints = currentCPs; 
            log("Syst√®me: Checkpoint cr√©√©.");
            renderCPList();
        }

        function loadCP(idx) {
            const cp = state.checkpoints[idx];
            const loadedState = JSON.parse(cp.data);
            const keptMaps = state.maps;
            const keptHistory = state.history;
            const keptCPs = state.checkpoints;
            state = loadedState;
            state.maps = keptMaps;
            state.history = keptHistory;
            state.checkpoints = keptCPs;
            document.getElementById('modalDeath').style.display='none';
            log(`--- RETOUR TEMPOREL (CHECKPOINT CHARG√â: Chap ${state.chapter}) ---`);
            changeTome(state.tome); initMap(); updateUI(); 
            alert("Checkpoint charg√© (Cartes et Historique conserv√©s).");
        }

        function renderCPList() {
            const d = document.getElementById('cpList'); d.innerHTML = "";
            (state.checkpoints || []).forEach((cp, i) => {
                d.innerHTML += `<div class="flex justify-between bg-gray-100 p-2 border border-gray-300 rounded text-xs font-sans">
                    <span class="font-bold">Chap ${cp.chap} <span class="font-normal text-gray-500">(${cp.date})</span></span> 
                    <button onclick="loadCP(${i})" class="text-blue-800 font-bold hover:underline">CHARGER</button>
                </div>`;
            });
        }

        // --- LOGIQUE JEU & D√âS ---
        let diceRes=0;
        function rollDiceVisual(n) {
            let tot=0; const con=document.getElementById('diceVisual'); con.innerHTML="";
            for(let i=0; i<n; i++) {
                let r=Math.floor(Math.random()*6)+1; tot+=r;
                con.innerHTML+=`<div class="w-8 h-8 bg-white border-2 border-gray-800 flex items-center justify-center font-bold shadow-md rounded text-lg font-serif">${r}</div>`;
            }
            diceRes=tot; document.getElementById('diceTotal').innerText="Total: "+tot;
            log(`D√©s (${n}d6): R√©sultat ${tot}`);
            document.getElementById('lkUp').disabled = state.hero.chance<=0;
            document.getElementById('lkDn').disabled = state.hero.chance<=0;
        }
        function useLuck(m) { 
            if(state.hero.chance>0){
                state.hero.chance--; diceRes+=m; document.getElementById('diceTotal').innerText="Total: "+diceRes; 
                log(`Chance: ${m>0?'+1':'-1'} au d√© -> ${diceRes}`); updateUI();
            } 
        }

        function combatRound() {
            const logDiv = document.getElementById('combatLog');
            const eName = document.getElementById('enemyName').value || "Ennemi";
            let ePV = parseInt(document.getElementById('enemyPV').value) || 0;
            const eDex = parseInt(document.getElementById('enemyDex').value) || 7;
            const bonus = parseInt(document.getElementById('combatWeapon').value);

            if(ePV <= 0) return;

            const rollH = Math.floor(Math.random()*6)+1 + Math.floor(Math.random()*6)+1;
            let msg = `<div class="mb-2 pb-1 border-b border-gray-200"><strong>Tour H√©ros:</strong> `;
            if(rollH <= state.hero.dex) {
                const dmg = 1 + Math.floor(Math.random()*6)+1 + bonus; ePV -= dmg; 
                msg += `<span class="text-green-700 font-bold">TOUCHE</span> (${rollH}) -> <span class="bg-red-100 px-1 rounded">-${dmg} PV</span></div>`;
                log(`Combat: Touch√© ${eName} pour ${dmg} d√©g√¢ts.`);
            } else { 
                msg += `<span class="text-red-400 font-bold">RATE</span> (${rollH})</div>`; 
                log(`Combat: Rat√© ${eName}.`);
            }

            if(ePV > 0) {
                const rollE = Math.floor(Math.random()*6)+1 + Math.floor(Math.random()*6)+1;
                msg += `<div class="mb-2"><strong>${eName}:</strong> `;
                if(rollE <= eDex) {
                    const dmgE = Math.floor(Math.random()*6)+1; state.hero.pv -= dmgE; if(state.hero.pv<0) state.hero.pv=0;
                    msg += `<span class="text-red-700 font-bold">TOUCHE</span> -> <span class="bg-red-200 px-1 rounded font-bold">-${dmgE} PV</span></div>`;
                    log(`Combat: ${eName} vous touche (-${dmgE} PV).`); checkDeath();
                } else { 
                    msg += `<span class="text-blue-400 font-bold">RATE</span></div>`; 
                    log(`Combat: ${eName} vous rate.`);
                }
            } else { 
                msg += `<div class="text-green-800 font-bold text-center mt-2 p-1 bg-green-100 rounded border border-green-300">üèÜ VICTOIRE !</div>`; ePV=0; 
                log(`Combat: Victoire contre ${eName} !`);
            }
            logDiv.innerHTML = msg + logDiv.innerHTML;
            document.getElementById('enemyPV').value = ePV; updateUI();
        }
        function resetCombat() { document.getElementById('combatLog').innerHTML=""; document.getElementById('enemyPV').value=""; }
        
        function checkDeath() {
            if(state.hero.pv <= 0) {
                log("H√âROS VAINCU (0 PV).");
                const m = document.getElementById('modalDeath'); 
                const c = document.getElementById('deathContent'); 
                m.style.display = 'flex';
                
                let html = `
                    <div class="bg-red-50 p-3 border border-red-300 rounded mb-4 text-left">
                        <label class="block font-bold text-red-900 mb-1">Le livre indique une suite ?</label>
                        <div class="flex gap-2">
                            <input id="defeatChapInput" type="number" placeholder="N¬∞" class="border p-1 text-lg w-20 rounded text-center font-bold">
                            <button onclick="goToDefeatChapter()" class="bg-red-700 text-[#f3e5ab] px-4 py-1 rounded font-bold hover:bg-red-800 shadow">S'Y RENDRE</button>
                        </div>
                        <p class="text-xs text-red-500 mt-1 italic">Note: Vous rel√®ve avec 1 PV.</p>
                    </div>
                `;

                if(state.mode==='Simplifi√©' && state.checkpoints.length>0) {
                    html += `<div class="text-left mt-4"><p class="font-bold mb-2">Ou charger un checkpoint :</p>`;
                    state.checkpoints.forEach((cp, idx) => {
                        html += `<button onclick="loadCP(${idx})" class="block w-full bg-blue-100 p-3 mt-1 rounded text-left text-sm hover:bg-blue-200 border border-blue-200 shadow-sm font-sans">
                            <i class="fas fa-undo"></i> Chap ${cp.chap} (${cp.date})
                        </button>`;
                    });
                    html += `</div>`;
                }
                
                html += `<hr class="my-6 border-red-200"><button onclick="location.reload()" class="bg-gray-800 text-white p-3 rounded w-full font-bold shadow-lg">RECOMMENCER L'AVENTURE</button>`;
                
                c.innerHTML = html;
            }
        }

        function goToDefeatChapter() {
            const val = document.getElementById('defeatChapInput').value;
            if(val) {
                state.hero.pv = 1;
                goToChapter(val);
                document.getElementById('modalDeath').style.display = 'none';
                log(`Suite d√©faite -> Chapitre ${val} (Rel√®vement 1 PV)`);
                updateUI();
            }
        }

        // --- CARTE & UTILS ---
        let canvas, ctx, isDr=false, cColor="black", cTool="pen", zoomLevel=1;
        
        function initMap() {
            canvas = document.getElementById('drawingCanvas'); ctx = canvas.getContext('2d');
            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start);
            canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('mouseup', stop); canvas.addEventListener('touchend', stop);
            loadMapImg();
        }

        function start(e) { 
            if(cTool === 'text') { 
                const p = pos(e); 
                const t = prompt("Texte de l'annotation :"); 
                if(t) { ctx.font="16px EB Garamond"; ctx.fillStyle=cColor; ctx.fillText(t,p.x,p.y); state.maps[state.currentMap]=canvas.toDataURL(); } 
                return; 
            }
            isDr = true; ctx.beginPath(); const p = pos(e); ctx.moveTo(p.x, p.y);
        }
        function draw(e) { 
            if(!isDr) return; e.preventDefault(); const p = pos(e); 
            ctx.lineWidth = cTool==='eraser'?20:2; 
            ctx.globalCompositeOperation = cTool==='eraser'?'destination-out':'source-over'; 
            ctx.lineCap = 'round';
            ctx.strokeStyle = cColor; ctx.lineTo(p.x, p.y); ctx.stroke(); 
        }
        function stop() { if(isDr){isDr=false; state.maps[state.currentMap]=canvas.toDataURL();} }
        
        function pos(e) { 
            const r = canvas.getBoundingClientRect(); 
            const x = (e.clientX || e.touches[0].clientX) - r.left;
            const y = (e.clientY || e.touches[0].clientY) - r.top;
            // Correction coordonn√©es si zoom CSS (Optionnel si on zoom le container, ici on zoom le container via CSS non)
            // Ici le zoom est g√©r√© par style.transform
            return { x: x / zoomLevel, y: y / zoomLevel }; 
        }

        function setPen(c) { cColor=c; cTool='pen'; document.querySelectorAll('#tab-carte button').forEach(b=>b.classList.remove('ring-2')); } 
        function setTool(t) { 
            cTool=t; 
            // Visual feedback
            ['btn-pen','btn-eraser','btn-text'].forEach(id => document.getElementById(id).classList.remove('bg-gray-400'));
            document.getElementById('btn-'+t).classList.add('bg-gray-400');
        }

        // --- MAP CONTROLS ---
        function addMap() { const n=prompt("Nom du nouveau plan:"); if(n) { state.maps[state.currentMap]=canvas.toDataURL(); state.maps[n]=""; state.currentMap=n; ctx.clearRect(0,0,2000,2000); updateMapSel(); } }
        function changeMap(n) { state.maps[state.currentMap]=canvas.toDataURL(); state.currentMap=n; ctx.clearRect(0,0,2000,2000); loadMapImg(); }
        function updateMapSel() { const s=document.getElementById('mapSelector'); s.innerHTML=""; Object.keys(state.maps).forEach(k=>{const o=document.createElement('option'); o.text=k; s.add(o);}); s.value=state.currentMap; }
        function loadMapImg() { const d=state.maps[state.currentMap]; if(d) { const i=new Image(); i.onload=()=>ctx.drawImage(i,0,0); i.src=d; } else ctx.clearRect(0,0,2000,2000); }

        function panMap(dx, dy) {
            const c = document.getElementById('mapContainer');
            c.scrollBy({left: dx, top: dy, behavior: 'smooth'});
        }
        function changeZoom(delta) {
            zoomLevel += delta;
            if(zoomLevel < 0.5) zoomLevel = 0.5;
            if(zoomLevel > 3) zoomLevel = 3;
            document.getElementById('drawingCanvas').style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoomDisplay').innerText = Math.round(zoomLevel*100) + "%";
        }

        // --- SAVE/LOAD ---
        function saveNotes() { state.notes = document.getElementById('persistentNotes').value; }
        function addLogNote() { const t = document.getElementById('quickNote').value; if(t) { log(`NOTE: ${t}`); document.getElementById('quickNote').value=""; } }
        function downloadSave() { state.maps[state.currentMap] = canvas.toDataURL(); const blob = new Blob([JSON.stringify(state)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `save_${state.hero.name}.json`; a.click(); }
        function loadFromFile(inp) {
            const f = inp.files[0]; const r = new FileReader();
            r.onload = (e) => {
                state = JSON.parse(e.target.result);
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                changeTome(state.tome); initMap(); updateUI(); renderHistory();
                log("Syst√®me: Fichier de sauvegarde charg√©.");
            };
            r.readAsText(f);
        }

        function updateUI() {
            const h = state.hero;
            document.getElementById('pvText').innerText = `${h.pv}/${h.pvMax}`;
            document.getElementById('pvBar').style.width = (h.pv/h.pvMax*100)+"%";
            document.getElementById('chanceText').innerText = h.chance;
            document.getElementById('chanceBar').style.width = (h.chance/12*100)+"%";
            document.getElementById('dexDisplay').innerText = h.dex;
            document.getElementById('talentDisplay').innerText = h.talent;
            document.getElementById('goldDisplay').value = h.gold;
            document.getElementById('chapterInput').value = state.chapter;
            document.getElementById('persistentNotes').value = state.notes || "";
            
            const qs = document.getElementById('quickSaveArea');
            if(state.mode === 'Simplifi√©') qs.classList.remove('hidden');
            else qs.classList.add('hidden');

            renderInventory(); renderCPList();
        }
        function log(m) { state.history.unshift(`[T${state.tome}|C${state.chapter}] ${m}`); renderHistory(); }
        function renderHistory() { document.getElementById('historyLog').innerHTML=state.history.join('<br>'); }
    </script>
</body>
</html>
